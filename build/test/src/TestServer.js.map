{"version":3,"sources":["src/TestServer.js"],"names":[],"mappings":"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","file":"src/TestServer.js","sourcesContent":["/*\n   Allows for CI - automated testing of the Node.js API\n\n   Uses PhantomJS to login, and click on the Allow / Decline\n   prompt for our OAuth tests.\n */\n\nvar urlLib = require('url');\nvar https = require('https');\nvar path = require('path');\nvar fs = require('fs');\n\nvar when = require('when');\nvar delay = require('when/delay');\nvar callbacks = require('when/callbacks');\nvar pipeline = require('when/pipeline');\nvar phantom = require('phantom');\n\nvar config = require('../config');\n\nmodule.exports = TestServer;\nfunction TestServer(port, responseStatus) {\n\n  var self = this;\n\n  self.port = port;\n  self.responseStatus = responseStatus;\n  self.server = void 0;\n  self.connections = [];\n\n  // Attempts to start the server on port 3000. If the port\n  // is in use, it will wait a moment and try again for a\n  // given number of attempts\n  //\n  // respond status should be set if this server should always\n  // respond with a status. By default it responds success.\n  self.start = function() {\n\n    var serverOptions = {\n      // @TODO this is pretty nasty. Using the '..' to get up out of the\n      // build directory & into the src to reference things that did\n      // not neeed to be built\n      key: fs.readFileSync(path.join(\n        __dirname, '..', '..', '..', 'test', 'src', 'ssl', 'key.pem')),\n      cert: fs.readFileSync(path.join(\n        __dirname, '..', '..', '..', 'test', 'src', 'ssl', 'cert.pem'))\n    };\n\n    self.server = https.createServer(serverOptions);\n\n    self.server.on('request', function(req, res) {\n      self.connections.push(req.connection);\n      if (self.responseStatus) {\n        res.writeHead(self.responseStatus);\n      }\n      res.end('');\n    });\n\n    return when.promise(function(resolve, reject) {\n      var attempts = 10;\n\n      function connect() {\n        try {\n          self.server.listen(self.port, '127.0.0.1');\n        } catch(e) {\n          --attempts;\n          console.error('trying again ' + attempts + ' left - ' + e.message);\n          if (attempts <= 0) {\n            return reject(e);\n          }\n          return setTimeout(connect, 500); // try again after 500ms\n        }\n\n        return resolve(); // we have connected!\n      }\n\n      connect();\n    }).then(function() {\n      return delay(2000);\n    });\n  };\n\n  self.stop = function() {\n    return when.promise(function(resolve, reject) {\n      self.connections.forEach(function(connection) {\n        connection.end();\n        connection.destroy();\n      });\n\n      self.server.close(function() {\n        // wait 2 seconds, then resolve\n        // console.log('stopping after 2 seconds...');\n        setTimeout(resolve, 2000);\n      });\n    }); // add a little delay to help free up the port\n  };\n\n  // opens the given url, and accepts the authentication\n  // unless `shouldRejectAuth` is true in which the authentication\n  // is rejected!\n  self.allowOrDeclineAuthUrl = function(url, shouldDecline) {\n\n    return when.promise(function(r) {\n      phantom.create(r, { parameters: { 'ignore-ssl-errors':'yes' }});\n    }).then(function(ph) {\n\n      return callbacks.call(ph.createPage).then(function(page) {\n\n        var loadInProgress = false;\n\n        page.set('onLoadStarted', function() {\n          loadInProgress = true;\n        });\n\n        page.set('onLoadFinished', function() {\n          loadInProgress = false;\n        });\n\n        function waitForLoadStarted() {\n          return when.promise(function(resolve) {\n            var interval = setInterval(function() {\n              if (loadInProgress) {\n                clearInterval(interval);\n                return resolve();\n              }\n            }, 1);\n          });\n        }\n\n        function waitForLoadFinished() {\n          return when.promise(function(resolve) {\n            var interval = setInterval(function() {\n              if (!loadInProgress) {\n                clearInterval(interval);\n                return resolve();\n              }\n            }, 1);\n          });\n        }\n\n        // Waits for a page started event, then waits for it to\n        // finish loading before resolving\n        function pageCycle() {\n          return waitForLoadStarted().then(waitForLoadFinished);\n        }\n\n        var steps = [\n          function() { // open the authentication page\n            var openPage = when.promise(function(r) { page.open(url, r); });\n            return when.join(pageCycle(), openPage);\n          },\n          function() { // login\n            var login =  when.promise(function(resolve, reject) {\n              page.evaluate(function(config) {\n                $('#user_login').val(config.reddit.login.username);\n                $('#passwd_login').val(config.reddit.login.password);\n                $('#login-form').submit();\n              }, resolve, config);\n            });\n\n            return when.join(pageCycle(), login);\n          },\n          function() { // click allow or deny button in form\n            var authenticate = when.promise(function(resolve, reject) {\n              var evalObj = {\n                shouldDecline: shouldDecline\n              };\n\n              page.evaluate(function(evalObj) {\n                if (evalObj.shouldDecline) {\n                  return jQuery('form[action=\"/api/v1/authorize\"]').submit();\n                } else {\n                  return jQuery('input[name=\"authorize\"]').click();\n                }\n              }, resolve, evalObj);\n\n            });\n\n            return when.join(pageCycle(), authenticate);\n          },\n          function() { // get the location href we have landed on\n\n            return delay(5000).then(function() {\n              return callbacks.call(page.evaluate, function() {\n                return document.location.href;\n              });\n            });\n\n          }\n        ];\n\n        return pipeline(steps);\n      }).then(function(url) {\n        // console.log(url);\n        url = url.replace('/#', '/?'); // implicit auth urls use # vs. ? for query str.\n        var parsed = urlLib.parse(url, true);\n        return parsed.query;\n      }).finally(function() {\n        ph.exit(); // kill phantom process\n      });\n\n    });\n\n  };\n\n  self.allowAuthUrl = function(url) {\n    return self.allowOrDeclineAuthUrl(url, false);\n  };\n\n  self.declineAuthUrl = function(url) {\n    return self.allowOrDeclineAuthUrl(url, true);\n  };\n\n  return self;\n}\n"],"sourceRoot":"/source/"}